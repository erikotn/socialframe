<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialFrame - Social Media Mockup Tool</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }

        /* Transparency Grid */
        .checkerboard {
            background-color: #18181b;
            background-image: 
                linear-gradient(45deg, #27272a 25%, transparent 25%), 
                linear-gradient(-45deg, #27272a 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #27272a 75%), 
                linear-gradient(-45deg, transparent 75%, #27272a 75%);
            background-size: 20px 20px;
        }
        
        /* Hide file inputs */
        input[type="file"] { display: none; }
        
        /* Fade in animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#09090b', 800: '#18181b', 700: '#27272a' },
                        social: { blue: '#0077b5', like: '#ef4444' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-white h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- IndexedDB Helper (Solves the storage limit issue) ---
        const DB_NAME = 'SocialFrameDB';
        const STORE_NAME = 'templates';
        const DB_VERSION = 1;

        const dbHelper = {
            open: () => {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            },
            getAll: async () => {
                try {
                    const db = await dbHelper.open();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction(STORE_NAME, 'readonly');
                        const request = tx.objectStore(STORE_NAME).getAll();
                        request.onsuccess = () => resolve(request.result.reverse()); // Newest first
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    console.error("DB Error", e);
                    return [];
                }
            },
            save: async (item) => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    store.put(item);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            },
            delete: async (id) => {
                const db = await dbHelper.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }
        };

        // --- Icons ---
        const Icons = {
            Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            User: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Image: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
            Smartphone: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" x2="12" y1="18" y2="18"/></svg>,
            Layout: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>,
            Heart: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="none"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>,
            Share: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
            Circle: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><circle cx="12" cy="12" r="10"/></svg>,
            Square: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="3" y="3" width="18" height="18" rx="4"/></svg>,
            Save: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Trash: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Library: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
        };

        function App() {
            // --- State ---
            const [mode, setMode] = useState('feed'); 
            const [sidebarTab, setSidebarTab] = useState('edit'); // 'edit' | 'library'
            const [loading, setLoading] = useState(false);
            const [savedDesigns, setSavedDesigns] = useState([]);
            
            // Content State
            const [content, setContent] = useState({
                avatar: null,
                mainImage: null,
                name: 'Bedrijfsnaam B.V.',
                text: 'Ontdek onze nieuwste collectie! We hebben hard gewerkt aan unieke designs die perfect aansluiten bij jouw stijl.',
                headline: 'Nieuwe Collectie Nu Beschikbaar',
                buttonText: 'Lees meer',
                url: 'bedrijfsnaam.nl'
            });

            // Frame/Background State
            const [style, setStyle] = useState({
                bgColor1: '#e4e4e7', 
                bgColor2: '#d4d4d8', 
                bgType: 'transparent',
                padding: 40,
                darkMode: false, 
                deviceShadow: true,
                deviceBorder: false,
                avatarShape: 'circle'
            });

            // --- Load from IndexedDB on mount ---
            useEffect(() => {
                const load = async () => {
                    const templates = await dbHelper.getAll();
                    setSavedDesigns(templates);
                };
                load();
            }, []);

            // --- Handlers ---
            const handleImageUpload = (key, e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = new Image();
                    img.onload = () => {
                        setContent(prev => ({ 
                            ...prev, 
                            [key]: { src: ev.target.result, width: img.naturalWidth, height: img.naturalHeight } 
                        }));
                    };
                    img.src = ev.target.result;
                };
                reader.readAsDataURL(file);
            };

            const updateContent = (key, val) => setContent(prev => ({ ...prev, [key]: val }));
            const updateStyle = (key, val) => setStyle(prev => ({ ...prev, [key]: val }));

            // --- Library Logic ---
            const saveDesign = async () => {
                const newDesign = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                    content,
                    style,
                    mode
                };
                
                try {
                    await dbHelper.save(newDesign);
                    const updated = await dbHelper.getAll();
                    setSavedDesigns(updated);
                    setSidebarTab('library'); // Switch to library
                } catch (e) {
                    alert("Could not save design. Storage might be unavailable.");
                    console.error(e);
                }
            };

            const loadDesign = (design) => {
                // Backward compatibility check for URL
                const safeContent = {
                    ...design.content,
                    url: design.content.url || design.content.name.toLowerCase().replace(/\s/g,'') + ".nl"
                };
                setContent(safeContent);
                setStyle(design.style);
                setMode(design.mode);
                setSidebarTab('edit'); 
            };

            const deleteDesign = async (id, e) => {
                e.stopPropagation();
                await dbHelper.delete(id);
                const updated = await dbHelper.getAll();
                setSavedDesigns(updated);
            };

            // --- Layout Calculations for Preview ---
            const layoutMetrics = useMemo(() => {
                if (mode !== 'feed') return {};
                
                const phoneW = 320;
                const phoneH = 650;
                const headerH = 80; 
                const footerH = 70; 
                const safetyPad = 20;

                let imgH = phoneW; 
                if (content.mainImage) {
                    const aspect = content.mainImage.height / content.mainImage.width;
                    imgH = phoneW * aspect;
                }

                const availableSpace = phoneH - headerH - footerH - imgH - safetyPad;

                return {
                    imgHeight: imgH,
                    maxTextHeight: Math.max(20, availableSpace) 
                };
            }, [mode, content.mainImage]);

            // --- Canvas Generation ---
            const generateCanvas = async () => {
                setLoading(true);
                await new Promise(r => setTimeout(r, 100)); 

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const scale = 2; 

                const phoneW = 375 * scale;
                const phoneH = 812 * scale; 
                const pad = style.padding * scale;
                
                const canvasW = phoneW + (pad * 2);
                const canvasH = phoneH + (pad * 2);

                canvas.width = canvasW;
                canvas.height = canvasH;

                // 1. Draw Canvas Background
                if (style.bgType === 'solid') {
                    ctx.fillStyle = style.bgColor1;
                    ctx.fillRect(0, 0, canvasW, canvasH);
                } else if (style.bgType === 'gradient') {
                    const grd = ctx.createLinearGradient(0, 0, canvasW, canvasH);
                    grd.addColorStop(0, style.bgColor1);
                    grd.addColorStop(1, style.bgColor2);
                    ctx.fillStyle = grd;
                    ctx.fillRect(0, 0, canvasW, canvasH);
                } else {
                    ctx.clearRect(0, 0, canvasW, canvasH);
                }

                const phoneX = pad;
                const phoneY = pad;
                const radius = 40 * scale;

                // 2. Phone Shadow
                if (style.deviceShadow) {
                    ctx.shadowColor = "rgba(0,0,0,0.3)";
                    ctx.shadowBlur = 40 * scale;
                    ctx.shadowOffsetY = 20 * scale;
                }
                
                // 3. Phone Body
                ctx.fillStyle = style.darkMode ? '#000000' : '#ffffff';
                ctx.beginPath();
                ctx.roundRect(phoneX, phoneY, phoneW, phoneH, radius);
                ctx.fill();

                // Reset Shadow
                ctx.shadowColor = "transparent";
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;

                // 4. Phone Border
                if (style.deviceBorder) {
                    ctx.lineWidth = 1.5 * scale;
                    ctx.strokeStyle = '#e4e4e7';
                    ctx.stroke();
                }

                // 5. Clip
                ctx.save();
                ctx.beginPath();
                ctx.roundRect(phoneX, phoneY, phoneW, phoneH, radius);
                ctx.clip();

                // --- Layout Logic ---
                const safeX = phoneX + (20 * scale);
                const safeW = phoneW - (40 * scale);
                let currentY = phoneY + (50 * scale); 

                const fontBold = (size) => `600 ${size * scale}px "Inter", sans-serif`;
                const fontReg = (size) => `400 ${size * scale}px "Inter", sans-serif`;

                // Status Bar & Top Elements
                ctx.fillStyle = (mode === 'story' || style.darkMode) ? '#fff' : '#000';
                ctx.font = fontBold(12);
                ctx.fillText("12:00", phoneX + (30 * scale), phoneY + (30 * scale));
                
                if (mode === 'feed') {
                    const mainImg = content.mainImage ? await loadImage(content.mainImage.src) : null;
                    let imgDrawH = phoneW; 
                    
                    if (mainImg) {
                        const aspect = mainImg.height / mainImg.width;
                        imgDrawH = phoneW * aspect;
                    }

                    const footerH = 80 * scale; 
                    const headerOffset = 70 * scale; 
                    const bottomBlockHeight = imgDrawH + footerH; 
                    const maxImageStartY = phoneY + phoneH - bottomBlockHeight;

                    const avatarSize = 40 * scale;
                    const avatarImg = content.avatar ? await loadImage(content.avatar.src) : null;
                    
                    ctx.save();
                    ctx.beginPath();
                    if (style.avatarShape === 'circle') {
                        ctx.arc(safeX + avatarSize/2, currentY + avatarSize/2, avatarSize/2, 0, Math.PI*2);
                    } else {
                        const r = 8 * scale;
                        ctx.roundRect(safeX, currentY, avatarSize, avatarSize, r);
                    }
                    ctx.closePath();
                    ctx.clip();
                    if (avatarImg) ctx.drawImage(avatarImg, safeX, currentY, avatarSize, avatarSize);
                    else { ctx.fillStyle = '#ccc'; ctx.fillRect(safeX, currentY, avatarSize, avatarSize); }
                    ctx.restore();

                    ctx.fillStyle = style.darkMode ? '#fff' : '#000';
                    ctx.font = fontBold(14);
                    ctx.textAlign = 'left';
                    ctx.fillText(content.name, safeX + avatarSize + (10 * scale), currentY + (15 * scale));
                    
                    ctx.fillStyle = '#a1a1aa';
                    ctx.font = fontReg(11);
                    ctx.fillText("Gesponsord â€¢ 2u", safeX + avatarSize + (10 * scale), currentY + (32 * scale));
                    
                    ctx.fillStyle = style.darkMode ? '#fff' : '#000';
                    ctx.fillText("...", phoneX + phoneW - (30 * scale), currentY + (20 * scale));

                    currentY += headerOffset;

                    ctx.fillStyle = style.darkMode ? '#fff' : '#18181b';
                    ctx.font = fontReg(14);
                    const lineHeight = 20 * scale;
                    const textLines = wrapText(ctx, content.text, safeW);
                    
                    const maxTextH = maxImageStartY - currentY - (10 * scale);
                    const maxLines = Math.floor(maxTextH / lineHeight);
                    
                    let linesDrawn = 0;
                    for (let i = 0; i < textLines.length; i++) {
                        if (linesDrawn >= maxLines) break;
                        if (linesDrawn === maxLines - 1 && i < textLines.length - 1) {
                            ctx.fillText(textLines[i] + "... lees meer", safeX, currentY);
                            currentY += lineHeight;
                            linesDrawn++;
                            break;
                        }
                        ctx.fillText(textLines[i], safeX, currentY);
                        currentY += lineHeight;
                        linesDrawn++;
                    }
                    
                    currentY += (10 * scale);
                    
                    if (mainImg) {
                        ctx.drawImage(mainImg, phoneX, currentY, phoneW, imgDrawH);
                    } else {
                        ctx.fillStyle = '#27272a';
                        ctx.fillRect(phoneX, currentY, phoneW, imgDrawH);
                    }
                    currentY += imgDrawH;

                    ctx.fillStyle = style.darkMode ? '#27272a' : '#f4f4f5';
                    ctx.fillRect(phoneX, currentY, phoneW, footerH);

                    ctx.fillStyle = style.darkMode ? '#fff' : '#000';
                    ctx.font = fontBold(13);
                    ctx.fillText(content.headline, safeX, currentY + (30 * scale));
                    
                    ctx.fillStyle = '#71717a';
                    ctx.font = fontReg(11);
                    // Use custom URL field
                    ctx.fillText(content.url || content.name.toLowerCase().replace(/\s/g,'') + ".nl", safeX, currentY + (50 * scale));

                    const btnW = 100 * scale;
                    const btnH = 36 * scale;
                    const btnX = phoneX + phoneW - (20 * scale) - btnW;
                    const btnY = currentY + (22 * scale);
                    
                    ctx.fillStyle = style.darkMode ? '#3f3f46' : '#e4e4e7'; 
                    ctx.beginPath();
                    ctx.roundRect(btnX, btnY, btnW, btnH, 4 * scale);
                    ctx.fill();

                    ctx.fillStyle = style.darkMode ? '#fff' : '#000';
                    ctx.font = fontBold(12);
                    ctx.textAlign = 'center';
                    ctx.fillText(content.buttonText, btnX + btnW/2, btnY + (22 * scale));

                } else {
                    const mainImg = content.mainImage ? await loadImage(content.mainImage.src) : null;
                    if (mainImg) {
                        const ratio = mainImg.width / mainImg.height;
                        const targetRatio = phoneW / phoneH;
                        let sw, sh, sx, sy;
                        if (ratio > targetRatio) {
                            sh = mainImg.height;
                            sw = sh * targetRatio;
                            sy = 0;
                            sx = (mainImg.width - sw) / 2;
                        } else {
                            sw = mainImg.width;
                            sh = sw / targetRatio;
                            sx = 0;
                            sy = (mainImg.height - sh) / 2;
                        }
                        ctx.drawImage(mainImg, sx, sy, sw, sh, phoneX, phoneY, phoneW, phoneH);
                    } else {
                        ctx.fillStyle = '#27272a';
                        ctx.fillRect(phoneX, phoneY, phoneW, phoneH);
                    }

                    const gradient = ctx.createLinearGradient(0, phoneY + phoneH/2, 0, phoneY + phoneH);
                    gradient.addColorStop(0, "transparent");
                    gradient.addColorStop(1, "rgba(0,0,0,0.8)");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(phoneX, phoneY + phoneH/2, phoneW, phoneH/2);

                    const avatarSize = 32 * scale;
                    const topY = phoneY + (50 * scale);
                    const avatarImg = content.avatar ? await loadImage(content.avatar.src) : null;

                    ctx.save();
                    ctx.beginPath();
                    if (style.avatarShape === 'circle') {
                        ctx.arc(safeX + avatarSize/2, topY + avatarSize/2, avatarSize/2, 0, Math.PI*2);
                    } else {
                        const r = 8 * scale;
                        ctx.roundRect(safeX, topY, avatarSize, avatarSize, r);
                    }
                    ctx.clip();
                    if (avatarImg) ctx.drawImage(avatarImg, safeX, topY, avatarSize, avatarSize);
                    else { ctx.fillStyle = '#ccc'; ctx.fillRect(safeX, topY, avatarSize, avatarSize); }
                    ctx.restore();

                    ctx.fillStyle = '#fff';
                    ctx.font = fontBold(13);
                    ctx.textAlign = 'left';
                    ctx.fillText(content.name, safeX + avatarSize + (10 * scale), topY + (20 * scale));

                    const iconX = phoneX + phoneW - (30 * scale);
                    const iconYStart = phoneY + phoneH - (150 * scale);
                    const iconGap = 50 * scale;

                    ctx.fillStyle = '#fff';
                    ctx.font = fontBold(20);
                    ctx.textAlign = 'center';
                    ctx.fillText("â¤ï¸", iconX, iconYStart); 
                    ctx.font = fontReg(12);
                    ctx.fillText("1.2k", iconX, iconYStart + (15*scale));
                    ctx.font = fontBold(20);
                    ctx.fillText("ðŸ’¬", iconX, iconYStart + iconGap);
                    ctx.fillText("âœˆï¸", iconX, iconYStart + (iconGap*2));
                }

                ctx.restore(); 
                const notchW = 100 * scale;
                const notchH = 25 * scale;
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.roundRect(phoneX + (phoneW - notchW)/2, phoneY + (10 * scale), notchW, notchH, 12 * scale);
                ctx.fill();

                canvas.toBlob((blob) => {
                    saveAs(blob, `${content.name.replace(/\s/g,'_')}_social.png`);
                    setLoading(false);
                }, 'image/png');
            };

            const loadImage = (src) => new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=src; });
            const wrapText = (ctx, text, maxWidth) => {
                const words = text.split(' ');
                let lines = [];
                let line = words[0];
                for (let i = 1; i < words.length; i++) {
                    let w = words[i];
                    let width = ctx.measureText(line + " " + w).width;
                    if (width < maxWidth) {
                        line += " " + w;
                    } else {
                        lines.push(line);
                        line = w;
                    }
                }
                lines.push(line);
                return lines;
            };

            return (
                <div className="flex flex-col md:flex-row h-screen">
                    <aside className="w-full md:w-96 bg-dark-800 border-r border-white/10 flex flex-col overflow-y-auto z-20 shadow-2xl">
                        <div className="p-6 border-b border-white/10">
                            <h1 className="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">SocialFrame</h1>
                            <p className="text-xs text-gray-400 mt-1">Universal Social Media Mockups</p>
                        </div>
                        
                        {/* Tab Switcher */}
                        <div className="flex border-b border-white/10">
                            <button 
                                onClick={() => setSidebarTab('edit')} 
                                className={`flex-1 py-3 text-sm font-medium transition-colors ${sidebarTab === 'edit' ? 'text-white border-b-2 border-blue-500' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                Edit
                            </button>
                            <button 
                                onClick={() => setSidebarTab('library')} 
                                className={`flex-1 py-3 text-sm font-medium transition-colors ${sidebarTab === 'library' ? 'text-white border-b-2 border-blue-500' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                Library <span className="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">{savedDesigns.length}</span>
                            </button>
                        </div>

                        {sidebarTab === 'edit' ? (
                            <div className="p-6 space-y-8 animate-fade-in">
                                <div className="flex bg-dark-900 p-1 rounded-lg border border-white/5">
                                    <button onClick={() => setMode('feed')} className={`flex-1 py-2 text-xs font-medium rounded-md flex items-center justify-center gap-2 transition-all ${mode === 'feed' ? 'bg-dark-700 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}>
                                        <Icons.Layout /> Feed
                                    </button>
                                    <button onClick={() => setMode('story')} className={`flex-1 py-2 text-xs font-medium rounded-md flex items-center justify-center gap-2 transition-all ${mode === 'story' ? 'bg-dark-700 text-white shadow' : 'text-gray-500 hover:text-gray-300'}`}>
                                        <Icons.Smartphone /> Story
                                    </button>
                                </div>

                                {/* Asset Uploads */}
                                <div className="space-y-4">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Assets</h3>
                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <div className="flex justify-between items-center mb-2">
                                                <label className="block text-xs text-gray-400">Avatar</label>
                                                <div className="flex bg-gray-800 rounded p-0.5">
                                                    <button onClick={() => updateStyle('avatarShape', 'circle')} className={`p-1 rounded ${style.avatarShape === 'circle' ? 'bg-gray-600 text-white' : 'text-gray-500 hover:text-gray-300'}`}><Icons.Circle /></button>
                                                    <button onClick={() => updateStyle('avatarShape', 'square')} className={`p-1 rounded ${style.avatarShape === 'square' ? 'bg-gray-600 text-white' : 'text-gray-500 hover:text-gray-300'}`}><Icons.Square /></button>
                                                </div>
                                            </div>
                                            <label className={`w-full aspect-square bg-dark-900 border border-dashed border-gray-600 flex items-center justify-center cursor-pointer hover:border-blue-500 transition-colors overflow-hidden group ${style.avatarShape === 'circle' ? 'rounded-full' : 'rounded-xl'}`}>
                                                {content.avatar ? <img src={content.avatar.src} className="w-full h-full object-cover" /> : <Icons.User />}
                                                <input type="file" accept="image/*" onChange={(e) => handleImageUpload('avatar', e)} />
                                            </label>
                                        </div>
                                        <div className="flex-[3]">
                                            <label className="block text-xs mb-2 text-gray-400">Main Photo</label>
                                            <label className="w-full h-24 bg-dark-900 border border-dashed border-gray-600 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 transition-colors overflow-hidden relative">
                                                {content.mainImage ? <img src={content.mainImage.src} className="w-full h-full object-cover opacity-50" /> : <div className="flex flex-col items-center text-gray-500"><Icons.Image /><span className="text-[10px] mt-1">Click to Upload</span></div>}
                                                <input type="file" accept="image/*" onChange={(e) => handleImageUpload('mainImage', e)} />
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Content</h3>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-1">Sender Name</label>
                                        <input type="text" value={content.name} onChange={e => updateContent('name', e.target.value)} className="w-full bg-dark-900 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none" />
                                    </div>
                                    {mode === 'feed' && (
                                        <>
                                            <div>
                                                <label className="block text-xs text-gray-400 mb-1">Post Text</label>
                                                <textarea rows="3" value={content.text} onChange={e => updateContent('text', e.target.value)} className="w-full bg-dark-900 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none resize-none"></textarea>
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">Headline</label>
                                                    <input type="text" value={content.headline} onChange={e => updateContent('headline', e.target.value)} className="w-full bg-dark-900 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-xs text-gray-400 mb-1">Button Label</label>
                                                    <input type="text" value={content.buttonText} onChange={e => updateContent('buttonText', e.target.value)} className="w-full bg-dark-900 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none" />
                                                </div>
                                                <div className="col-span-2">
                                                    <label className="block text-xs text-gray-400 mb-1">Website URL</label>
                                                    <input type="text" value={content.url} onChange={e => updateContent('url', e.target.value)} className="w-full bg-dark-900 border border-gray-700 rounded px-3 py-2 text-sm focus:border-blue-500 outline-none" />
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>

                                <div className="space-y-4">
                                    <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Style</h3>
                                    <div className="flex items-center justify-between">
                                        <span className="text-sm text-gray-300">Dark Mode UI</span>
                                        <button onClick={() => updateStyle('darkMode', !style.darkMode)} className={`w-10 h-5 rounded-full relative transition-colors ${style.darkMode ? 'bg-blue-600' : 'bg-gray-700'}`}>
                                            <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${style.darkMode ? 'left-6' : 'left-1'}`}></div>
                                        </button>
                                    </div>
                                    <div className="space-y-2 pt-2 border-t border-white/5">
                                        <div className="flex items-center justify-between">
                                            <span className="text-sm text-gray-400">Device Shadow</span>
                                            <button onClick={() => updateStyle('deviceShadow', !style.deviceShadow)} className={`w-10 h-5 rounded-full relative transition-colors ${style.deviceShadow ? 'bg-blue-600' : 'bg-gray-700'}`}>
                                                <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${style.deviceShadow ? 'left-6' : 'left-1'}`}></div>
                                            </button>
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <span className="text-sm text-gray-400">Device Border</span>
                                            <button onClick={() => updateStyle('deviceBorder', !style.deviceBorder)} className={`w-10 h-5 rounded-full relative transition-colors ${style.deviceBorder ? 'bg-blue-600' : 'bg-gray-700'}`}>
                                                <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all ${style.deviceBorder ? 'left-6' : 'left-1'}`}></div>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs text-gray-400 mb-2">Background</label>
                                        <div className="flex gap-2">
                                            <div className="h-8 w-8 rounded-full overflow-hidden border border-gray-600 relative bg-zinc-200 cursor-pointer">
                                                <input type="color" value={style.bgColor1} onChange={e => updateStyle('bgColor1', e.target.value)} className="opacity-0 w-full h-full scale-150 cursor-pointer" />
                                            </div>
                                            {style.bgType === 'gradient' && (
                                                <div className="h-8 w-8 rounded-full overflow-hidden border border-gray-600 relative bg-zinc-300 cursor-pointer">
                                                    <input type="color" value={style.bgColor2} onChange={e => updateStyle('bgColor2', e.target.value)} className="opacity-0 w-full h-full scale-150 cursor-pointer" />
                                                </div>
                                            )}
                                            <select value={style.bgType} onChange={e => updateStyle('bgType', e.target.value)} className="ml-auto bg-dark-900 border border-gray-700 rounded px-2 text-xs">
                                                <option value="solid">Solid</option>
                                                <option value="gradient">Gradient</option>
                                                <option value="transparent">Transparent</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex gap-2 pt-4">
                                    <button onClick={saveDesign} className="flex-1 bg-gray-700 text-white font-bold py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                                        <Icons.Save /> Save as Template
                                    </button>
                                    <button onClick={generateCanvas} disabled={loading} className="flex-1 bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
                                        {loading ? '...' : <><Icons.Download /> PNG</>}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="p-4 space-y-4 animate-fade-in">
                                {savedDesigns.length === 0 ? (
                                    <div className="text-center text-gray-500 py-10">
                                        <p className="mt-2 text-sm">No saved designs yet.</p>
                                    </div>
                                ) : (
                                    savedDesigns.map(design => (
                                        <div key={design.id} onClick={() => loadDesign(design)} className="bg-dark-700 border border-white/5 rounded-lg p-3 cursor-pointer hover:border-blue-500 transition-colors group relative flex gap-3">
                                            {/* Mini Thumbnail */}
                                            <div className="w-10 h-10 rounded bg-gray-800 flex-shrink-0 overflow-hidden border border-white/10">
                                                {design.content.mainImage ? (
                                                    <img src={design.content.mainImage.src} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="w-full h-full flex items-center justify-center text-gray-600"><Icons.Image /></div>
                                                )}
                                            </div>
                                            <div className="flex-1 overflow-hidden">
                                                <div className="flex justify-between items-start mb-0.5">
                                                    <span className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">{design.mode}</span>
                                                    <button onClick={(e) => deleteDesign(design.id, e)} className="text-gray-500 hover:text-red-400 p-0.5"><Icons.Trash /></button>
                                                </div>
                                                <p className="text-sm font-medium text-white truncate">{design.content.name}</p>
                                                <p className="text-[10px] text-gray-500">{design.date}</p>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </aside>

                    {/* Preview Area */}
                    <main className="flex-1 bg-black relative flex items-center justify-center p-8 checkerboard overflow-hidden">
                        <div className="relative transition-all duration-300 shadow-2xl"
                            style={{
                                padding: style.bgType === 'transparent' ? 0 : `${style.padding}px`,
                                background: style.bgType === 'transparent' ? 'transparent' : (style.bgType === 'solid' ? style.bgColor1 : `linear-gradient(135deg, ${style.bgColor1}, ${style.bgColor2})`)
                            }}
                        >
                            <div className={`relative overflow-hidden transition-all duration-300 ${style.darkMode ? 'bg-black' : 'bg-white'} rounded-[40px]`}
                                style={{
                                    width: '320px',
                                    height: '650px',
                                    boxShadow: style.deviceShadow ? '0 20px 40px rgba(0,0,0,0.3)' : 'none',
                                    border: style.deviceBorder ? '1.5px solid #e4e4e7' : 'none'
                                }}
                            >
                                <div className="absolute top-2 left-1/2 -translate-x-1/2 w-24 h-6 bg-black rounded-full z-20"></div>

                                {mode === 'feed' && (
                                    <div className="pt-12 flex flex-col h-full relative">
                                        <div className="px-4 flex items-center gap-3 mb-3 flex-shrink-0">
                                            <div className={`w-10 h-10 bg-gray-200 overflow-hidden flex-shrink-0 ${style.avatarShape === 'circle' ? 'rounded-full' : 'rounded-xl'}`}>
                                                {content.avatar && <img src={content.avatar.src} className="w-full h-full object-cover" />}
                                            </div>
                                            <div className="flex-1">
                                                <h3 className={`text-sm font-semibold ${style.darkMode ? 'text-white' : 'text-black'}`}>{content.name}</h3>
                                                <p className="text-[10px] text-gray-400">Gesponsord â€¢ 2u</p>
                                            </div>
                                            <div className={style.darkMode ? 'text-white' : 'text-black'}>...</div>
                                        </div>

                                        <div 
                                            className={`px-4 mb-3 text-sm ${style.darkMode ? 'text-gray-200' : 'text-gray-800'} overflow-hidden`}
                                            style={{ maxHeight: layoutMetrics.maxTextHeight ? `${layoutMetrics.maxTextHeight}px` : 'auto' }}
                                        >
                                            <p className="whitespace-pre-wrap leading-snug">
                                                {content.text}
                                            </p>
                                        </div>

                                        <div className=""> 
                                            <div className="w-full bg-gray-100 relative" style={{ height: layoutMetrics.imgHeight ? `${layoutMetrics.imgHeight}px` : '320px' }}>
                                                {content.mainImage ? (
                                                    <img src={content.mainImage.src} className="w-full h-full object-cover" />
                                                ) : (
                                                    <div className="absolute inset-0 flex items-center justify-center text-gray-400 bg-gray-800">No Image</div>
                                                )}
                                            </div>
                                            <div className={`px-4 h-[70px] ${style.darkMode ? 'bg-dark-700' : 'bg-gray-100'} flex items-center justify-between`}>
                                                <div className="flex-1 pr-2">
                                                    <p className={`text-xs font-bold ${style.darkMode ? 'text-white' : 'text-black'}`}>{content.headline}</p>
                                                    <p className="text-[10px] text-gray-500">
                                                        {content.url || content.name.toLowerCase().replace(/\s/g,'') + ".nl"}
                                                    </p>
                                                </div>
                                                <div className={`px-3 py-1.5 rounded text-[10px] font-bold ${style.darkMode ? 'bg-dark-800 text-white border border-gray-600' : 'bg-white text-black border border-gray-200'}`}>
                                                    {content.buttonText}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {mode === 'story' && (
                                    <div className="h-full relative w-full flex flex-col">
                                        <div className="absolute inset-0 bg-gray-800">
                                            {content.mainImage && <img src={content.mainImage.src} className="w-full h-full object-cover" />}
                                            <div className="absolute inset-x-0 bottom-0 h-1/2 bg-gradient-to-t from-black/80 to-transparent"></div>
                                        </div>
                                        <div className="relative z-10 pt-12 px-4 flex items-center gap-2">
                                            <div className={`w-8 h-8 border border-white/20 bg-gray-200 overflow-hidden ${style.avatarShape === 'circle' ? 'rounded-full' : 'rounded-lg'}`}>
                                                {content.avatar && <img src={content.avatar.src} className="w-full h-full object-cover" />}
                                            </div>
                                            <span className="text-white text-sm font-semibold shadow-black drop-shadow-md">{content.name}</span>
                                        </div>
                                        <div className="mt-auto relative z-10 p-4 pb-12 flex flex-col items-end gap-6 text-white">
                                            <div className="flex flex-col items-center gap-1"><Icons.Heart /><span className="text-[10px]">1.2k</span></div>
                                            <div className="flex flex-col items-center gap-1"><div className="transform scale-90"><Icons.Layout /></div></div>
                                            <div className="flex flex-col items-center gap-1"><Icons.Share /></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
